<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direction Tracking with IMU</title>
    <style>
        #direction {
            font-size: 24px;
            font-family: Arial, sans-serif;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <button onclick="initializeTracking()">Start Tracking</button>
    <div id="direction">Current Direction: 0°</div>

    <script>
        let currentDirection = 0; // כיוון נוכחי במעלות
        let lastTimestamp = null; // זמן הקריאה האחרונה
        let alphaFiltered = 0; // כיוון משולב עם Complementary Filter
        const alphaWeight = 0.98; // משקל עבור נתוני הג'ירוסקופ
        const tiltThreshold = 10; // זווית מקסימלית שמותרת להטיה אנכית (במעלות)

        function initializeTracking() {
            // בקשת הרשאה אם נדרש (לדוגמה, ב-iOS)
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            startTrackingRotation();
                        } else {
                            console.log("Permission denied for motion sensors.");
                        }
                    })
                    .catch(error => console.error("Error requesting permission:", error));
            } else {
                startTrackingRotation();
            }
        }

        function startTrackingRotation() {
            window.addEventListener("devicemotion", function(event) {
                const currentTime = event.timeStamp; // הזמן הנוכחי מהאירוע
                if (lastTimestamp === null) {
                    lastTimestamp = currentTime;
                    return;
                }

                // חישוב הזמן שעבר מאז העדכון האחרון (בשניות)
                const deltaTime = (currentTime - lastTimestamp) / 1000;
                lastTimestamp = currentTime;

                // קבלת מהירות זוויתית (שיעור סיבוב על ציר Z בלבד)
                const gyroAlpha = event.rotationRate.alpha || 0;

                // קבלת זווית מהאקסלרומטר
                const accelX = event.accelerationIncludingGravity.x || 0;
                const accelY = event.accelerationIncludingGravity.y || 0;
                const accelZ = event.accelerationIncludingGravity.z || 0;

                // חישוב הטיה אנכית (tilt) בצירים שאינם Z
                const pitch = Math.atan2(accelY, accelZ) * (180 / Math.PI);
                const roll = Math.atan2(accelX, accelZ) * (180 / Math.PI);

                // אם ההטיה האנכית חורגת מהסף, השתמש בג'ירוסקופ בלבד
                if (Math.abs(pitch) > tiltThreshold || Math.abs(roll) > tiltThreshold) {
                    console.log("Tilt detected. Using gyro only.");
                    currentDirection += gyroAlpha * deltaTime; // רק ג'ירוסקופ
                } else {
                    // חישוב שינוי בכיוון מ-gyro (אינטגרציה)
                    const gyroDelta = gyroAlpha * deltaTime;

                    // חישוב כיוון מהאקסלרומטר (רק אם הטיה אנכית נמוכה)
                    const accelDirection = Math.atan2(accelY, accelX) * (180 / Math.PI);

                    // שילוב Complementary Filter
                    alphaFiltered = alphaWeight * (alphaFiltered + gyroDelta) + (1 - alphaWeight) * accelDirection;

                    // עדכון הכיוון הנוכחי
                    currentDirection = (alphaFiltered + 360) % 360; // שמירה בטווח 0-360 מעלות
                }

                // עדכון התצוגה על המסך
                document.getElementById("direction").innerText = `Current Direction: ${currentDirection.toFixed(2)}°`;

                console.log(`Filtered Direction: ${currentDirection.toFixed(2)}°, Pitch: ${pitch.toFixed(2)}, Roll: ${roll.toFixed(2)}`);
            }, true);
        }
    </script>
</body>
</html>
