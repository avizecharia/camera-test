<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Motion with Box Movement</title>
    <style>
        #box {
            width: 100px;
            height: 100px;
            background-color: rgb(26, 51, 119);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: transform 0.1s ease-out;  /* חלקות בתנועה */
        }

        .data-display {
            position: fixed;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 10px;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div id="box"></div>
    <button onclick="initializeMotion()">Allow Motion Sensors</button>

    <!-- תצוגה של הנתונים -->
    <div id="orientationData" class="data-display">
        <p>Alpha: <span id="alphaValue">0</span></p>
        <p>Beta: <span id="betaValue">0</span></p>
        <p>Gamma: <span id="gammaValue">0</span></p>
    </div>
    <div id="motionData" class="data-display" style="top: 150px;">
        <p>AccelX: <span id="accelX">0</span></p>
        <p>AccelY: <span id="accelY">0</span></p>
        <p>AccelZ: <span id="accelZ">0</span></p>
        <p>RotationAlpha: <span id="rotationAlpha">0</span></p>
    </div>

    <script>
        let deviceOrientationListener;
        let deviceMotionListener;
        let initialAlpha = null;  // נשמור את הערך של alpha לשימוש בעת השינוי

        function initializeMotion() {
            // אם הדפדפן תומך בהרשאה (כמו ב-iOS), נבקש הרשאה
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            startDeviceOrientation();  // התחלת המעקב אחרי DeviceOrientation אם ההרשאה ניתנה
                        } else {
                            console.log("Permission denied for motion sensors.");
                        }
                    })
                    .catch(error => {
                        console.error("Error requesting permission:", error);
                    });
            } else {
                // אם הדפדפן לא דורש הרשאה, נתחיל את המעקב מיד
                startDeviceOrientation();
            }
        }

        // התחלת המעקב אחרי DeviceOrientation (כדי לקבוע את הכיוון)
        function startDeviceOrientation() {
            deviceOrientationListener = function (event) {
                let alpha = event.alpha;  // סיבוב סביב ציר Z (מצפן)
                let beta = event.beta;    // הטיית המכשיר סביב ציר X
                let gamma = event.gamma;  // הטיית המכשיר סביב ציר Y
                
                // הצגת הנתונים על המסך
                document.getElementById('alphaValue').innerText = alpha.toFixed(2);
                document.getElementById('betaValue').innerText = beta.toFixed(2);
                document.getElementById('gammaValue').innerText = gamma.toFixed(2);

                console.log("DeviceOrientation - alpha:", alpha, "beta:", beta, "gamma:", gamma);

                // נשמור את הערך של alpha כדי לשמור את כיוון המכשיר
                if (initialAlpha === null) {
                    initialAlpha = alpha;  // אם זה הפעם הראשונה, נשמור את alpha
                }

                // ברגע שקבענו את הכיוון, נוכל לעבור ל-DeviceMotion
                stopDeviceOrientation();
                startDeviceMotion();
            };

            window.addEventListener("deviceorientation", deviceOrientationListener, true);
        }

        // הפסקת המעקב אחרי DeviceOrientation
        function stopDeviceOrientation() {
            if (deviceOrientationListener) {
                window.removeEventListener("deviceorientation", deviceOrientationListener, true);
                deviceOrientationListener = null;
                console.log("DeviceOrientation stopped");
            }
        }

        // התחלת המעקב אחרי DeviceMotion (לאחר קביעת הכיוון)
        function startDeviceMotion() {
            deviceMotionListener = function (event) {
                let accelX = event.acceleration.x;
                let accelY = event.acceleration.y;
                let accelZ = event.acceleration.z;
                let rotationRateAlpha = event.rotationRate.alpha;
                let rotationRateBeta = event.rotationRate.beta;
                let rotationRateGamma = event.rotationRate.gamma;

                // הצגת נתוני התאוצה והסיבוב על המסך
                document.getElementById('accelX').innerText = accelX.toFixed(2);
                document.getElementById('accelY').innerText = accelY.toFixed(2);
                document.getElementById('accelZ').innerText = accelZ.toFixed(2);
                document.getElementById('rotationAlpha').innerText = rotationRateAlpha.toFixed(2);

                console.log("DeviceMotion - AccelX:", accelX, "AccelY:", accelY, "AccelZ:", accelZ);
                console.log("DeviceMotion - RotationAlpha:", rotationRateAlpha, "RotationBeta:", rotationRateBeta, "RotationGamma:", rotationRateGamma);

                // זווית חדשה של המכשיר, התנועה והסיבוב (נעשה שימוש ב-alpha כדי לחשב את מיקום הקוביה)
                moveBox(accelX, accelY, rotationRateAlpha);
            };

            window.addEventListener('devicemotion', deviceMotionListener, true);
        }

        // פונקציה להזזת הקוביה על המסך
        function moveBox(accelX, accelY, rotationRateAlpha) {
            const element = document.getElementById('box');
            if (!element) return;

            // הגדרת רגישות לתנועה
            const sensitivity = 5;

            // חישוב מיקום הקוביה על סמך תאוצה ושיעור סיבוב
            let offsetX = accelX * sensitivity;
            let offsetY = accelY * sensitivity;

            // התאמת המיקום בתוך גבולות המסך
            offsetX = Math.max(0, Math.min(window.innerWidth - element.offsetWidth, offsetX));
            offsetY = Math.max(0, Math.min(window.innerHeight - element.offsetHeight, offsetY));

            // סיבוב הקוביה על סמך הערך של rotationRateAlpha
            let rotation = initialAlpha ? rotationRateAlpha + (initialAlpha || 0) : rotationRateAlpha;

            // עדכון המיקום והסיבוב של הקוביה
            element.style.transform = `translate(${offsetX}px, ${offsetY}px) rotate(${rotation}deg)`;
        }
    </script>
</body>
</html>
