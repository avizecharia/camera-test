<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direction Tracking with Filter</title>
    <style>
        #direction {
            font-size: 24px;
            font-family: Arial, sans-serif;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <button onclick="initializeTracking()">Start Tracking</button>
    <div id="direction">Current Direction: 0°</div>

    <script>
        let currentDirection = 0; // כיוון נוכחי במעלות
        let initialDirection = null; // כיוון ראשוני
        let lastTimestamp = null; // זמן הקריאה האחרונה
        let smoothedRotationRate = 0; // ערך מסונן של rotationRate.alpha
        const smoothingFactor = 0.1; // מידת החלקת הנתונים (ערך בין 0 ל-1)

        function initializeTracking() {
            // בקשת הרשאה אם נדרש (לדוגמה, ב-iOS)
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            getInitialDirection();
                        } else {
                            console.log("Permission denied for motion sensors.");
                        }
                    })
                    .catch(error => console.error("Error requesting permission:", error));
            } else {
                getInitialDirection();
            }
        }

        function getInitialDirection() {
            window.addEventListener("deviceorientation", function(event) {
                // קבלת הכיוון הראשוני (רק alpha, ציר Z)
                if (initialDirection === null) {
                    initialDirection = event.alpha || 0; // נקבע את הכיוון הראשוני
                    currentDirection = initialDirection;
                    console.log("Initial Direction:", initialDirection);
                }

                // הפסקת המעקב אחרי DeviceOrientation, ומעבר ל-DeviceMotion
                startTrackingRotation();
                window.removeEventListener("deviceorientation", arguments.callee, true);
            }, true);
        }

        function startTrackingRotation() {
            window.addEventListener("devicemotion", function(event) {
                const currentTime = event.timeStamp; // הזמן הנוכחי מהאירוע
                if (lastTimestamp === null) {
                    lastTimestamp = currentTime;
                    return;
                }

                // חישוב הזמן שעבר מאז העדכון האחרון (בשניות)
                const deltaTime = (currentTime - lastTimestamp) / 1000;
                lastTimestamp = currentTime;

                // קבלת מהירות זוויתית (שיעור סיבוב על ציר Z בלבד)
                let rotationRateAlpha = event.rotationRate.alpha || 0;

                // החלקת הנתונים עם מסנן Low-Pass
                smoothedRotationRate = smoothingFactor * rotationRateAlpha + (1 - smoothingFactor) * smoothedRotationRate;

                // עדכון הכיוון הנוכחי לפי מהירות זוויתית המסוננת וזמן שעבר
                currentDirection += smoothedRotationRate * deltaTime; // מהירות זוויתית כפול זמן
                currentDirection = (currentDirection + 360) % 360; // שמירה בטווח 0-360 מעלות

                // עדכון התצוגה על המסך
                document.getElementById("direction").innerText = `Current Direction: ${currentDirection.toFixed(2)}°`;

                console.log(`Updated Direction: ${currentDirection.toFixed(2)}°, Smoothed Rate: ${smoothedRotationRate.toFixed(2)}`);
            }, true);
        }
    </script>
</body>
</html>
