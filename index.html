<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dual Compass UI</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #f0f0f0;
        }

        .compass-container {
            display: flex;
            justify-content: space-around;
            width: 100%;
            max-width: 500px;
        }

        .compass {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 5px solid #333;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background-color: white;
        }

        .needle {
            position: absolute;
            width: 2px;
            height: 70px;
            background-color: red;
            transform-origin: 50% 100%;
            transform: rotate(0deg);
        }

        #imuButton {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #333;
            color: white;
            border: none;
            cursor: pointer;
        }

        #imuButton:focus {
            outline: none;
        }

        #direction {
            font-size: 18px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Dual Compass</h1>

    <div class="compass-container">
        <div id="magneticCompass" class="compass">
            <div id="needleMagnetic" class="needle"></div>
        </div>
        <div id="imuCompass" class="compass">
            <div id="needleIMU" class="needle"></div>
        </div>
    </div>

    <button id="imuButton" onclick="toggleIMU()">Switch to IMU Compass</button>
    <div id="direction">Current Direction: 0°</div>

    <script>
        let currentDirectionMagnetic = 0; // כיוון במעלות מהמצפן המגנטי
        let currentDirectionIMU = 0; // כיוון במעלות מה-IMU
        let lastTimestamp = null; // זמן הקריאה האחרון
        let initialDirection = null; // כיוון התחלתי ממגנומטר
        let usingIMU = false; // מצב של שימוש ב-IMU או לא
        const alphaWeight = 0.98; // משקל עבור נתוני הג'ירוסקופ
        const tiltThreshold = 10; // סף להטיה

        // מצפן מגנטי (המגנומטר)
        function startMagneticCompass() {
            if (window.DeviceOrientationEvent) {
                window.addEventListener("deviceorientation", function(event) {
                    if (!usingIMU) {
                        let alpha = event.alpha || 0;
                        // הגדרת כיוון התחלתי אם עדיין לא הוגדר
                        if (initialDirection === null) {
                            initialDirection = alpha;
                            currentDirectionMagnetic = initialDirection;
                        }
                        currentDirectionMagnetic = alpha; // עדכון כיוון המכשיר בעזרת המצפן
                        updateNeedle('needleMagnetic', currentDirectionMagnetic);
                    }
                }, true);
            }
        }

        // מצפן IMU (באמצעות הג'ירוסקופ ואקסלרומטר)
        function startIMUCompass() {
            window.addEventListener("devicemotion", function(event) {
                const currentTime = event.timeStamp; // הזמן הנוכחי מהאירוע
                if (lastTimestamp === null) {
                    lastTimestamp = currentTime;
                    return;
                }

                const deltaTime = (currentTime - lastTimestamp) / 1000;
                lastTimestamp = currentTime;

                const gyroAlpha = event.rotationRate.alpha || 0; // נתון הג'ירוסקופ סביב ציר Z
                const accelX = event.accelerationIncludingGravity.x || 0;
                const accelY = event.accelerationIncludingGravity.y || 0;
                const accelZ = event.accelerationIncludingGravity.z || 0;

                const pitch = Math.atan2(accelY, accelZ) * (180 / Math.PI);
                const roll = Math.atan2(accelX, accelZ) * (180 / Math.PI);

                // אם יש הטיה אנכית חורגת מהסף, מתעלמים מהעדכון
                if (Math.abs(pitch) > tiltThreshold || Math.abs(roll) > tiltThreshold) {
                    console.log("Tilt detected. Ignoring update.");
                    return;
                }

                const gyroDelta = gyroAlpha * deltaTime;
                const accelDirection = Math.atan2(accelY, accelX) * (180 / Math.PI);

                // שילוב הנתונים עם Complementary Filter
                currentDirectionIMU += gyroDelta;
                currentDirectionIMU = (currentDirectionIMU + 360) % 360; // שמירה בטווח 0-360 מעלות
                updateNeedle('needleIMU', currentDirectionIMU);
            }, true);
        }

        // עדכון הסמן של המצפן
        function updateNeedle(needleId, direction) {
            const needle = document.getElementById(needleId);
            needle.style.transform = `rotate(${direction}deg)`;
        }

        // פונקציה להעברת מצפן למצב IMU
        function toggleIMU() {
            if (!usingIMU) {
                // כשמעבירים ל-IMU, נפסיק את המצפן המגנטי
                usingIMU = true;
                document.getElementById("imuButton").innerText = "Switch to Magnetic Compass";
                startIMUCompass(); // מתחילים את המעקב עם ה-IMU
            } else {
                // חזרה למצב מצפן מגנטי
                usingIMU = false;
                document.getElementById("imuButton").innerText = "Switch to IMU Compass";
                startMagneticCompass(); // מתחילים את המעקב עם המגנומטר
            }
        }

        // מתחילים במצב מצפן מגנטי
        startMagneticCompass();
    </script>
</body>
</html>
    