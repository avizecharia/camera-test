<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compass with IMU</title>
    <style>
        #direction {
            font-size: 24px;
            font-family: Arial, sans-serif;
            margin-top: 20px;
        }

        #imuButton {
            margin-top: 20px;
            padding: 10px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <h1>Compass Example</h1>

    <div id="direction">Current Direction: 0°</div>

    <button id="imuButton" onclick="toggleIMU()">Switch to IMU Compass</button>

    <script>
        let currentDirection = 0; // כיוון נוכחי במעלות
        let lastTimestamp = null; // זמן הקריאה האחרונה
        let initialDirection = null; // הכיוון ההתחלתי (אם אנחנו מתחילים עם המגנומטר)
        let usingIMU = false; // מצב מצפן IMU
        const alphaWeight = 0.98; // משקל עבור נתוני הג'ירוסקופ
        const tiltThreshold = 5; // סף להטיה

        // מצפן אמיתי (במגנומטר)
        function startMagneticCompass() {
            if (window.DeviceOrientationEvent) {
                window.addEventListener("deviceorientation", function(event) {
                    if (!usingIMU) {
                        let alpha = event.alpha || 0;
                        // הגדרת כיוון התחלתי אם עדיין לא הוגדר
                        if (initialDirection === null) {
                            initialDirection = alpha;
                            currentDirection = initialDirection;
                        }
                        currentDirection = alpha; // עדכון כיוון המכשיר בעזרת המצפן
                        document.getElementById("direction").innerText = `Compass (Magnetic): ${currentDirection.toFixed(2)}°`;
                    }
                }, true);
            }
        }

        // מצפן בעזרת IMU (שימוש בג'ירוסקופ ואקסלרומטר)
        function startIMUCompass() {
            window.addEventListener("devicemotion", function(event) {
                const currentTime = event.timeStamp; // הזמן הנוכחי מהאירוע
                if (lastTimestamp === null) {
                    lastTimestamp = currentTime;
                    return;
                }

                const deltaTime = (currentTime - lastTimestamp) / 1000;
                lastTimestamp = currentTime;

                const gyroAlpha = event.rotationRate.alpha || 0; // נתון הג'ירוסקופ סביב ציר Z
                const accelX = event.accelerationIncludingGravity.x || 0;
                const accelY = event.accelerationIncludingGravity.y || 0;
                const accelZ = event.accelerationIncludingGravity.z || 0;

                const pitch = Math.atan2(accelY, accelZ) * (180 / Math.PI);
                const roll = Math.atan2(accelX, accelZ) * (180 / Math.PI);

                // אם יש הטיה אנכית חורגת מהסף, מתעלמים מהעדכון
                if (Math.abs(pitch) > tiltThreshold || Math.abs(roll) > tiltThreshold) {
                    console.log("Tilt detected. Ignoring update.");
                    return;
                }

                const gyroDelta = gyroAlpha * deltaTime;
                const accelDirection = Math.atan2(accelY, accelX) * (180 / Math.PI);

                // שילוב הנתונים עם Complementary Filter
                currentDirection += gyroDelta;
                currentDirection = (currentDirection + 360) % 360; // שמירה בטווח 0-360 מעלות

                document.getElementById("direction").innerText = `IMU Compass: ${currentDirection.toFixed(2)}°`;
            }, true);
        }

        // פונקציה להעברת מצפן למצב IMU
        function toggleIMU() {
            if (!usingIMU) {
                // כשמעבירים ל-IMU, נפסיק את המצפן המגנטי
                usingIMU = true;
                document.getElementById("imuButton").innerText = "Switch to Magnetic Compass";
                startIMUCompass(); // מתחילים את המעקב עם ה-IMU
            } else {
                // חזרה למצב מצפן מגנטי
                usingIMU = false;
                document.getElementById("imuButton").innerText = "Switch to IMU Compass";
                startMagneticCompass(); // מתחילים את המעקב עם המגנומטר
            }
        }

        // מתחילים במצב מצפן מגנטי
        startMagneticCompass();
    </script>
</body>
</html>
