<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מצפן דינמי עם שליטה</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            flex-direction: column;
        }
        #compass {
            width: 300px;
            height: 300px;
            border: 2px solid black;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background: #f0f0f0;
        }
        .needle {
            width: 2px;
            height: 100px;
            background-color: red;
            position: absolute;
            transform-origin: 50% 100%;
        }
        .number {
            position: absolute;
            font-size: 18px;
            font-weight: bold;
            color: black;
        }
        #status {
            margin-top: 20px;
        }
        #toggleButton {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="compass">
        <div class="needle" id="needle"></div>
        <div class="number" style="top: 10px;">N</div>
        <div class="number" style="top: 140px; left: 140px;">E</div>
        <div class="number" style="bottom: 10px;">S</div>
        <div class="number" style="top: 140px; left: -40px;">W</div>
    </div>
    <div id="status">המצפן מכובה</div>
    <button id="toggleButton">הפעל/כבה את המצפן</button>
    <script>
        let compassActive = false;  // משתנה שמייצג אם המצפן פעיל או לא
        let initialOrientation = null;
        let lastAlpha = null, lastBeta = null, lastGamma = null;
        let compassEventListener = null;
        // עוזר לחשב את הכיוון של המכשיר
        function updateNeedleRotation(alpha) {
            const needle = document.getElementById('needle');
            needle.style.transform = `rotate(${alpha}deg)`;  // הזווית היא האלפא (סיבוב סביב ציר Z)
        }
        // הפעלת המצפן
        function activateCompass(event) {
            const alpha = event.alpha; // זווית של המצפן (צפון מגנטי)
            if (alpha !== null && compassActive) {
                updateNeedleRotation(alpha);
            }
        }
        // אם נתוני המצפן זמינים
        if (window.DeviceOrientationEvent) {
            compassEventListener = (event) => activateCompass(event);
        }
        // אם המצפן לא זמין (למשל במנהרה), השתמש בגירוסקופ ובאקסלרומטר
        if (window.DeviceMotionEvent) {
            window.addEventListener("devicemotion", (event) => {
                if (!compassActive) {  // אם אין מצפן, השתמש בחיישני תנועה
                    const rotationRate = event.rotationRate;
                    const beta = event.accelerationIncludingGravity.x;  // תאוצה בציר ה-X
                    const gamma = event.accelerationIncludingGravity.y; // תאוצה בציר ה-Y
                    // אם לא היה מצפן, התחילו לחשב את סיבוב המכשיר
                    if (lastAlpha === null) {
                        lastAlpha = beta;  // זווית התחלית בציר ה-X
                        lastBeta = gamma;  // זווית התחלית בציר ה-Y
                    }
                    // חישוב שינויים בסיבוב המכשיר (בהנחה ששני הצירים ינועו)
                    const deltaAlpha = beta - lastAlpha;
                    const deltaBeta = gamma - lastBeta;
                    const alpha = deltaAlpha + deltaBeta;  // חיבור השינויים
                    // עדכון זווית המטרה
                    if (compassActive) {
                        updateNeedleRotation(alpha);
                    }
                    lastAlpha = beta;
                    lastBeta = gamma;
                }
            });
        } else {
            document.getElementById("status").textContent = "לא נמצאו חיישני תנועה.";
        }
        // כיבוי/הפעלה של המצפן
        document.getElementById("toggleButton").addEventListener("click", () => {
            compassActive = !compassActive; // משנה את מצב המצפן (הפוך מ-True ל-False ולהפך)
            if (compassActive) {
                document.getElementById("status").textContent = "המצפן פעיל";
                // הפעלת ה-EventListener של המצפן אם נתון
                if (compassEventListener) {
                    window.addEventListener("deviceorientation", compassEventListener);
                }
            } else {
                document.getElementById("status").textContent = "המצפן כובא";
                // הסרת ה-EventListener של המצפן
                window.removeEventListener("deviceorientation", compassEventListener);
            }
        });
    </script>
</body>
</html>